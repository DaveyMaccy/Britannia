<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Britannia 60 AD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0c;
        }
        .font-title {
            font-family: 'IM Fell English', serif;
        }
        /* OSRS-inspired UI */
        .panel, .modal-content {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFElEQVQYV2NkYGD4z4AB_wEl/wEANnsFBFd246oAAAAASUVORK5CYII=');
            background-color: #2e2820; /* OSRS brown */
            border: 4px solid #000;
            box-shadow: inset 0 0 0 2px #5a4a3a;
        }
        .panel-header {
            color: #ff9900; /* OSRS yellow */
            text-shadow: 1px 1px #000;
        }
        .sidebar-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            color: #c7c7c7;
        }
        .sidebar-tab.active {
            border-color: #ff9900; /* OSRS yellow */
            color: #ff9900;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #5a4a3a; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #7a6a5a; }

        .story-content p { margin-bottom: 1rem; }
        .creation-page { max-height: 75vh; overflow-y: auto; }
        .info-box { background-color: #1a1a1a; border-left: 3px solid #ff9900; }
        @keyframes pulse {
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-black text-gray-300">

    <div id="root">
        <!-- The entire UI will be built by JavaScript inside this container -->
    </div>

    <script>
        // --- CORE GAME DATA & STATE MANAGEMENT (GLOBAL VARIABLES) ---
        
        let gameState = {};
        let turnCounter = 0;
        let apiKey = '';
        let coreRulesText = '';
        let scenarioData = {};
        let uiData = {};
        let creationPage = 1;

        // --- ALL FUNCTION DEFINITIONS (DEFINED FIRST TO PREVENT ERRORS) ---

        function rollDice(count, sides) {
            let total = 0;
            for (let i = 0; i < count; i++) total += Math.floor(Math.random() * sides) + 1;
            return total;
        }

        function mergeDeep(target, source) {
            const output = { ...target };
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target))
                            Object.assign(output, { [key]: source[key] });
                        else
                            output[key] = mergeDeep(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }
        
        async function loadGameData() {
            const rulesResponse = await fetch('./CoreRules.json');
            if (!rulesResponse.ok) throw new Error('Could not load CoreRules.json');
            coreRulesText = await rulesResponse.text();

            const scenarioResponse = await fetch('./Scenario.json');
            if (!scenarioResponse.ok) throw new Error('Could not load Scenario.json');
            scenarioData = await scenarioResponse.json();

            const uiResponse = await fetch('./UI.json');
            if (!uiResponse.ok) throw new Error('Could not load UI.json');
            uiData = await uiResponse.json();
        }

        function buildElement(config) {
            const el = document.createElement(config.tag);
            if (config.id) el.id = config.id;
            if (config.className) el.className = config.className;
            if (config.type) el.type = config.type;
            if (config.placeholder) el.placeholder = config.placeholder;
            if (config.name) el.name = config.name;
            if (config.value) el.value = config.value;
            if (config.checked) el.checked = true;
            if (config.innerHTML) el.innerHTML = config.innerHTML;
            if (config.children) {
                config.children.forEach(childConfig => {
                    el.appendChild(buildElement(childConfig));
                });
            }
            return el;
        }
        
        function buildUIFromJSON() {
            const root = document.getElementById('root');
            root.innerHTML = ''; // Clear any existing content (like the loading screen)
            uiData.layout.forEach(config => root.appendChild(buildElement(config)));
        }

        function initializeStartScreen() {
            const continueBtn = document.getElementById('continue-game-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const clearDataBtn = document.getElementById('clear-data-btn');

            const savedApiKey = localStorage.getItem('rpgApiKey');
            if (savedApiKey) apiKeyInput.value = savedApiKey;
            
            const savedGame = localStorage.getItem('rpgGameState');
            const hasValidSave = savedGame && JSON.parse(savedGame).turnCounter > 0;

            if (hasValidSave) {
                continueBtn.disabled = false;
                continueBtn.addEventListener('click', () => {
                    if (setApiKey()) loadGameFromLocalStorage();
                });
            } else {
                continueBtn.disabled = true;
            }
            
            newGameBtn.addEventListener('click', () => {
                if (hasValidSave) {
                    if (confirm('Starting a new game will delete your previous locally stored game files. Are you sure?')) {
                         if (setApiKey()) showSetupModal();
                    }
                } else {
                    if (setApiKey()) showSetupModal();
                }
            });
            
            clearDataBtn.addEventListener('click', clearLocalStorage);
        }

        function setApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const key = apiKeyInput.value.trim();
            if (!key) {
                alert('Please enter a valid API Key to continue.');
                return false;
            }
            apiKey = key;
            localStorage.setItem('rpgApiKey', key);
            return true;
        }

        function showSetupModal() {
            localStorage.removeItem('rpgGameState');

            document.getElementById('start-modal').classList.add('hidden');
            const modal = document.getElementById('setup-modal');
            const skillsContainer = document.getElementById('core-skills-selection');
            const gearContainer = document.getElementById('gear-selection');
            skillsContainer.innerHTML = ''; 
            gearContainer.innerHTML = '';
            
            scenarioData.available_skills.forEach(skill => {
                skillsContainer.innerHTML += `<div><label data-info="${skill.toLowerCase().replace(/\s/g, '_').replace(/[()]/g, '')}"><input type="checkbox" id="skill-${skill.toLowerCase()}" value="${skill}" class="skill-checkbox mr-2">${skill}</label></div>`;
            });
            
            Object.entries(scenarioData.starting_gear_options).forEach(([category, items]) => {
                let itemsHTML = items.map(item => `
                    <div class="ml-4"><label><input type="checkbox" class="gear-checkbox" value="${item}"> ${item}</label></div>
                `).join('');
                gearContainer.innerHTML += `<details class="mb-2" open><summary class="font-bold cursor-pointer">${category}</summary>${itemsHTML}</details>`;
            });

            document.querySelectorAll('.skill-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
                    if (checkedCount > 3) {
                        alert('You can only select up to 3 core skills.');
                        checkbox.checked = false;
                    }
                });
            });
            
            document.getElementById('terminator-mode').addEventListener('change', (e) => {
                 document.querySelectorAll('.gear-checkbox').forEach(cb => {
                    cb.disabled = e.target.checked;
                    if(e.target.checked) cb.checked = false;
                 });
            });

            modal.classList.remove('hidden');
            setupInfoBoxListeners();
            setupCreationNav();
        }
        
        function setupCreationNav() {
            document.getElementById('next-btn').addEventListener('click', () => navigateCreation(1));
            document.getElementById('prev-btn').addEventListener('click', () => navigateCreation(-1));
            document.getElementById('create-char-btn').addEventListener('click', createCharacter);
        }

        function navigateCreation(direction) {
            if (direction > 0 && creationPage === 2) {
                const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
                if (checkedCount > 3) {
                    alert('You can select a maximum of 3 core skills.');
                    return;
                }
            }

            document.getElementById(`creation-page-${creationPage}`).classList.add('hidden');
            creationPage += direction;
            document.getElementById(`creation-page-${creationPage}`).classList.remove('hidden');

            document.getElementById('prev-btn').classList.toggle('hidden', creationPage === 1);
            document.getElementById('next-btn').classList.toggle('hidden', creationPage === 4);
            document.getElementById('create-char-btn').classList.toggle('hidden', creationPage !== 4);
        }

        function setupInfoBoxListeners() {
            const infoBox = document.getElementById('info-box-content');
            const infoContent = {
                default: `<h3>Information</h3><p>Hover over an item on the left to learn more about it.</p>`,
                attributes: `<h3>Attributes</h3><p>Your four core stats. They determine your raw, untrained potential. Choosing a strongest attribute gives a +25 bonus to its starting roll.</p>`,
                core_skills: `<h3>Core Skills</h3><p>Your primary talents. You can choose up to 3. They start with a higher value (+25 bonus) and represent what your character is naturally good at.</p>`,
                languages: `<h3>Languages</h3><p>Your starting fluency. Higher fluency makes communication easier and opens up more social options.</p>`,
                athleticism: `<h3>Athleticism</h3><p>Governs physical prowess like running, jumping, and swimming. Increases your daily travel distance on foot.</p>`,
                survival: `<h3>Survival</h3><p>Your ability to find food, water, and shelter in the wild. Essential for staying alive outside of settlements.</p>`,
                improvisation: `<h3>Improvisation</h3><p>The skill of creating tools and solutions from available materials, heavily influenced by your modern knowledge.</p>`,
                stealth: `<h3>Stealth</h3><p>Allows you to move unseen and unheard, useful for avoiding conflict or gaining a tactical advantage.</p>`,
                first_aid: `<h3>First Aid</h3><p>Your ability to treat wounds and injuries. Can be significantly boosted by applying correct modern medical knowledge.</p>`,
                observation: `<h3>Observation</h3><p>Your ability to notice fine details, spot ambushes, or discern if someone is lying.</p>`,
                melee_improvised: `<h3>Melee (Improvised)</h3><p>Fighting with whatever you can find, from your pen knife to a tree branch. Represents untrained close-quarters combat.</p>`,
                unarmed_combat: `<h3>Unarmed Combat</h3><p>Your skill in hand-to-hand fighting, using fists, feet, and grappling.</p>`,
                ranged_combat: `<h3>Ranged Combat</h3><p>Your proficiency with projectile weapons like bows, slings, or even a modern firearm.</p>`,
                tactics: `<h3>Tactics</h3><p>Your understanding of battlefield strategy. Can be used to command others or gain an advantage in a fight.</p>`,
                lore: `<h3>Lore</h3><p>Knowledge of history, local customs, and beliefs. Crucial for navigating the complex social and political landscape.</p>`
            };
            
            infoBox.innerHTML = infoContent.default;

            document.querySelectorAll('[data-info]').forEach(el => {
                el.addEventListener('mouseenter', () => {
                    infoBox.innerHTML = infoContent[el.dataset.info] || infoContent.default;
                });
            });
        }

        function createCharacter() {
            let newGameState = {};
            
            const name = document.getElementById('char-name').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const height = document.getElementById('char-height').value;
            const weight = document.getElementById('char-weight').value;
            const build = document.getElementById('char-build').value;
            const skin = document.getElementById('char-skin').value;
            const hairStyle = document.getElementById('char-hair-style').value;
            const hairColor = document.getElementById('char-hair-color').value;
            const eyeColor = document.getElementById('char-eye-color').value;
            const details = document.getElementById('char-details').value;
            
            const bonusAttr = document.getElementById('attr-bonus').value;
            const selectedSkills = Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(cb => cb.value);
            const brittonicFluency = parseInt(document.getElementById('lang-brittonic').value, 10);
            const latinFluency = parseInt(document.getElementById('lang-latin').value, 10);

            const terminatorMode = document.getElementById('terminator-mode').checked;
            const selectedGear = terminatorMode ? [] : Array.from(document.querySelectorAll('.gear-checkbox:checked')).map(cb => cb.value);

            const startLocation = document.querySelector('input[name="start-location"]:checked').value;
            
            if (!name || !gender || !height || !weight) {
                alert('Please ensure all fields on Page 1 are complete.');
                navigateCreation(1 - creationPage);
                return;
            }

            const physicalDescription = `Gender: ${gender}. ${height}, ${weight}, ${build} build. ${hairColor} ${hairStyle} hair, ${eyeColor} eyes, and ${skin} skin. ${details}`;

            newGameState.turnCounter = 1;
            newGameState.characterSheet = {
                name: name,
                physicalDescription: physicalDescription,
                health: "Healthy",
                survivalStatus: "Sated, Hydrated, Warm",
                attributes: {},
                skills: {},
                languages: { "Common Brittonic": brittonicFluency, "Vulgar Latin": latinFluency },
                inventory: { currency: 0, items: selectedGear },
                location: "Parisi Territory",
                factionReputation: {}
            };
            newGameState.playerKnowledge = { knownCharacters: {}, knownFactions: {} };
            newGameState.worldState = { currentDate: "60.03.03", currentTime: "16:00", majorEvents: ["Arrived in the territory of the Parisi."] };
            newGameState.keyCharacters = scenarioData.initial_key_characters;
            newGameState.factions = scenarioData.faction_data;
            
            Object.keys(newGameState.factions).forEach(f => {
                newGameState.characterSheet.factionReputation[f] = 0;
            });

            ['STR', 'DEX', 'WITS', 'CHA'].forEach(attr => {
                let roll = rollDice(5, 20);
                if (attr === bonusAttr) roll += 25;
                newGameState.characterSheet.attributes[attr] = Math.min(100, roll);
            });

            scenarioData.available_skills.forEach(skill => {
                let roll = selectedSkills.includes(skill) ? rollDice(3, 20) + 25 : rollDice(3, 20);
                newGameState.characterSheet.skills[skill] = { value: roll, type: selectedSkills.includes(skill) ? 'core' : 'other' };
            });

            gameState = newGameState;

            let startingMessage = scenarioData.starting_situations[startLocation] || scenarioData.starting_situations.wilderness;
            
            if(startLocation === 'roman_city') {
                const cities = ["Camulodunum", "Londinium", "Verulamium"];
                const city = cities[Math.floor(Math.random() * cities.length)];
                startingMessage = startingMessage.replace('[CITY]', city);
                gameState.characterSheet.location = city;
            } else if (startLocation === 'tribal_holding') {
                const holdings = ["the Iceni capital", "the Parisi capital", "Stanwick, the Brigante capital"];
                const holding = holdings[Math.floor(Math.random() * holdings.length)];
                startingMessage = startingMessage.replace('[HOLDING]', holding);
                gameState.characterSheet.location = holding;
            }

            startGame(startingMessage);
        }

        function startGame(startingMessage) {
            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('action-form').addEventListener('submit', handlePlayerAction);
            document.getElementById('save-btn').addEventListener('click', handleSave);
            document.getElementById('load-btn').addEventListener('click', handleLoad);
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
            
            document.getElementById('tab-character').addEventListener('click', () => switchTab('character'));
            document.getElementById('tab-known-characters').addEventListener('click', () => switchTab('known-characters'));
            document.getElementById('tab-factions').addEventListener('click', () => switchTab('factions'));
            document.getElementById('tab-console').addEventListener('click', () => switchTab('console'));

            turnCounter = gameState.turnCounter || 1;
            updateUI();
            addStoryMessage(startingMessage, "GM");
        }

        // --- UI & RENDER FUNCTIONS ---
        function renderFactions() {
            const display = document.getElementById('factions-panel');
            const factions = gameState.factions || {};
             display.innerHTML = Object.keys(factions).map(name => `
                <div class="mb-2 text-sm p-2 bg-gray-700 rounded">
                    <p><strong>${name}:</strong> ${gameState.characterSheet.factionReputation[name] || 0} Rep</p>
                </div>
            `).join('');
        }
        
        function renderKeyCharacters() {
            const display = document.getElementById('known-characters-panel');
            const knownChars = gameState.playerKnowledge.knownCharacters || {};
            if (Object.keys(knownChars).length === 0) {
                display.innerHTML = `<p class="text-gray-500 italic">You have not met any key characters yet.</p>`;
                return;
            }
            display.innerHTML = Object.entries(knownChars).map(([name, data]) => `
                <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <h3 class="font-title text-lg text-yellow-400">${name}</h3>
                    ${data.description ? `<p class="text-sm"><strong>Known Info:</strong> ${data.description}</p>` : ''}
                    ${data.status ? `<p class="text-sm"><strong>Status:</strong> ${data.status}</p>` : ''}
                </div>
            `).join('');
        }
        
        function renderCharacterPanel() {
            const display = document.getElementById('character-panel');
            const pc = gameState.characterSheet;
            let inventoryHTML = pc.inventory.items.map(item => `<li>${item}</li>`).join('');
            display.innerHTML = `
                <div class="space-y-4">
                    <div><h3 class="font-title text-xl text-yellow-400">${pc.name}</h3><p class="text-sm italic">${pc.physicalDescription}</p></div>
                    <div><p><strong>Health:</strong> <span class="text-green-400">${pc.health}</span></p><p><strong>Status:</strong> ${pc.survivalStatus}</p></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Inventory</h4><ul class="text-sm"><li>${pc.inventory.currency} Denarii</li>${inventoryHTML}</ul></div>
                </div>
            `;
        }

        function renderGameState() {
            const display = document.getElementById('game-state-display');
            const pc = gameState.characterSheet;
            
            let skillsHTML = Object.entries(pc.skills).map(([name, data]) => 
                `<li class="${data.type === 'core' ? 'text-yellow-400' : ''}">${name}: ${data.value}</li>`
            ).join('');

            let languagesHTML = Object.entries(pc.languages).map(([name, fluency]) =>
                `<li>${name}: ${fluency}%</li>`
            ).join('');

            display.innerHTML = `
                <div class="space-y-4">
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Attributes</h4><ul class="text-sm"><li>STR: ${pc.attributes.STR}</li><li>DEX: ${pc.attributes.DEX}</li><li>WITS: ${pc.attributes.WITS}</li><li>CHA: ${pc.attributes.CHA}</li></ul></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Skills</h4><ul class="text-sm">${skillsHTML}</ul></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Languages</h4><ul class="text-sm">${languagesHTML}</ul></div>
                </div>
            `;
        }
        
        function updateUI() {
            renderGameState();
            renderKeyCharacters();
            renderFactions();
            renderCharacterPanel();
        }
        
        function addStoryMessage(html, sender="GM") {
            const content = document.getElementById('story-content');
            const messageDiv = document.createElement('div');
            
            if (sender === "Player") {
                messageDiv.className = 'text-right mb-4';
                messageDiv.innerHTML = `<div class="bg-yellow-700 inline-block p-3 rounded-lg text-left"><em>${html}</em></div>`;
            } else {
                const header = document.createElement('p');
                header.className = 'text-sm text-yellow-300 font-title';
                header.textContent = `[Turn ${turnCounter} | ${gameState.worldState.currentDate} | ${gameState.worldState.currentTime}]`;
                content.appendChild(header);
                
                messageDiv.className = 'mb-4';
                messageDiv.innerHTML = html;
            }
            
            content.appendChild(messageDiv);
            document.getElementById('story-container').scrollTop = document.getElementById('story-container').scrollHeight;
        }

        function logToConsole(message, data) {
            const consolePanel = document.getElementById('console-panel');
            const entry = document.createElement('div');
            entry.className = 'mb-2 p-2 bg-gray-700 rounded';
            let content = `<strong>${message}</strong>`;
            if (data) {
                content += `<pre class="whitespace-pre-wrap text-xs">${JSON.stringify(data, null, 2)}</pre>`;
            }
            entry.innerHTML = content;
            consolePanel.appendChild(entry);
            consolePanel.scrollTop = consolePanel.scrollHeight;
        }

        // --- GAME LOGIC ---

        async function handlePlayerAction(event) {
            event.preventDefault();
            const input = document.getElementById('action-input');
            const actionText = input.value.trim();
            if (!actionText) return;

            addStoryMessage(actionText, "Player");
            input.value = '';
            input.disabled = true;
            document.querySelector('#action-form button').disabled = true;

            const fullPrompt = constructFullPrompt(actionText);
            logToConsole('Sending Prompt to API...', { promptLength: fullPrompt.length });
            const apiResponse = await callGeminiAPI(fullPrompt);
            logToConsole('Received Response from API:', apiResponse);
            
            processApiResponse(apiResponse);

            turnCounter++;
            gameState.turnCounter = turnCounter;
            
            saveGameToLocalStorage();
            updateUI();
            
            input.disabled = false;
            document.querySelector('#action-form button').disabled = false;
            input.focus();
        }

        function processApiResponse(response) {
            if (response.stateChanges) {
                gameState = mergeDeep(gameState, response.stateChanges);
            }
            addStoryMessage(response.narrative, "GM");
        }
        
        // --- SAVE / LOAD LOGIC ---

        function saveGameToLocalStorage() {
            localStorage.setItem('rpgGameState', JSON.stringify(gameState));
        }

        function loadGameFromLocalStorage() {
            const savedGame = localStorage.getItem('rpgGameState');
            if (savedGame) {
                gameState = JSON.parse(savedGame);
                const lastEvent = gameState.worldState.majorEvents[gameState.worldState.majorEvents.length - 1] || "your journey";
                startGame(`Game loaded. You continue ${lastEvent}.`);
            }
        }

        function handleSave() {
            const jsonString = JSON.stringify(gameState);
            const base64String = btoa(jsonString);
            const textArea = document.getElementById('save-load-data');
            textArea.value = base64String;
            textArea.select();
            document.execCommand('copy');
            alert('Backup code copied to clipboard!');
        }
        
        function handleLoad() {
            const textArea = document.getElementById('save-load-data');
            loadGameFromCode(textArea.value);
        }

        function loadGameFromCode(saveCode) {
            if (!saveCode.trim()) {
                alert('Please paste a save code into the text area first.');
                return;
            }
            try {
                const jsonString = atob(saveCode);
                const loadedData = JSON.parse(jsonString);

                if (loadedData.characterSheet) {
                    gameState = loadedData;
                    document.getElementById('story-content').innerHTML = '';
                    const lastEvent = gameState.worldState.majorEvents[gameState.worldState.majorEvents.length - 1] || "your journey";
                    startGame(`Game loaded from code. You continue ${lastEvent}.`);
                } else {
                    throw new Error('Invalid save file structure.');
                }
            } catch (error) {
                console.error("Failed to load game:", error);
                alert('Failed to load game. The save code appears to be invalid or corrupted.');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('rpgGameState');
            localStorage.removeItem('rpgApiKey');
            document.getElementById('api-key-input').value = '';
            document.getElementById('continue-game-btn').disabled = true;
            alert('All local data has been cleared.');
        }

        // --- MODAL & UI LOGIC ---

        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            document.getElementById('settings-api-key').value = apiKey;
            document.getElementById('settings-char-desc').value = gameState.characterSheet.physicalDescription;
            modal.classList.remove('hidden');
            
            document.getElementById('settings-apply-btn').onclick = applySettings;
            document.getElementById('settings-cancel-btn').onclick = () => modal.classList.add('hidden');
            document.getElementById('return-to-start-btn').onclick = () => window.location.reload();
        }

        function applySettings() {
            const newApiKey = document.getElementById('settings-api-key').value.trim();
            const newDesc = document.getElementById('settings-char-desc').value.trim();

            if (newApiKey) {
                apiKey = newApiKey;
                localStorage.setItem('rpgApiKey', apiKey);
            }
            if (newDesc) {
                gameState.characterSheet.physicalDescription = newDesc;
            }
            
            saveGameToLocalStorage();
            updateUI();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function switchTab(tabName) {
            ['character', 'known-characters', 'factions', 'console'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`${t}-panel`).classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');
        }

        // --- API & DATA PARSING ---

        function constructFullPrompt(playerAction) {
            const gameStateString = JSON.stringify(gameState, null, 2);
            return `
                --- CORE RULES ---
                ${coreRulesText}

                --- SCENARIO CONTEXT ---
                ${JSON.stringify(scenarioData, null, 2)}

                --- CURRENT GAME STATE (JSON) ---
                ${gameStateString}

                --- PLAYER ACTION ---
                ${playerAction}
            `;
        }

        async function callGeminiAPI(prompt) {
            if (!apiKey) {
                alert("API Key is not set. Please refresh and enter your key.");
                return { narrative: `<p class="text-red-400">Error: API Key is missing.</p>`, stateChanges: {} };
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API call failed with status: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                const responseText = data.candidates[0].content.parts[0].text;
                return JSON.parse(responseText);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                logToConsole("API Error:", error.message);
                return {
                    narrative: `<p class="text-red-400">Error connecting to the AI. Please check the console for details.</p>`,
                    stateChanges: {}
                };
            }
        }
        
        // --- SCRIPT EXECUTION START ---
        document.addEventListener('DOMContentLoaded', async () => {
            const root = document.getElementById('root');
            root.innerHTML = `<div class="fixed inset-0 bg-black flex items-center justify-center z-50">
                <h1 class="font-title text-5xl text-yellow-400 animate-pulse-slow">Loading Game Data...</h1>
            </div>`;

            try {
                await loadGameData();
                buildUIFromJSON(uiData.layout);
                initializeStartScreen();
            } catch (error) {
                root.innerHTML = `<div class="text-red-400 p-8"><strong>Error loading game files:</strong> ${error.message}.<br><br>Please ensure <strong>CoreRules.json</strong> and <strong>Scenario.json</strong> are in the same folder as this index.html file.</div>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>
