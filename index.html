<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Britannia 60 AD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-title {
            font-family: 'IM Fell English', serif;
        }
        /* Custom scrollbar for a better aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #718096; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* gray-500 */
        }
        .story-content p {
            margin-bottom: 1rem;
        }
        .creation-page {
            max-height: 75vh;
            overflow-y: auto;
        }
        .info-box {
            background-color: #1a202c;
            border-left: 2px solid #f6e05e;
        }
        .sidebar-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
        }
        .sidebar-tab.active {
            border-color: #f6e05e; /* yellow-400 */
            color: #f6e05e;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="flex flex-col md:flex-row h-screen hidden">

        <!-- Left Sidebar: Game State & Character -->
        <aside class="w-full md:w-1/4 bg-gray-800 p-4 flex flex-col h-[40vh] md:h-screen">
            <div class="flex-grow overflow-y-auto">
                <h2 class="font-title text-2xl text-yellow-300 border-b-2 border-yellow-500 pb-2 mb-4">Game State</h2>
                <div id="game-state-display">
                    <!-- Game state will be rendered here by JavaScript -->
                </div>
            </div>
            <div class="mt-auto pt-4 border-t border-gray-700 space-y-4">
                <div>
                    <h3 class="font-title text-xl text-yellow-300 mb-2">Backup & Transfer</h3>
                    <div class="space-y-2">
                        <textarea id="save-load-data" class="w-full bg-gray-900 text-xs rounded p-2 h-24 resize-none" placeholder="Save or load your game code here..."></textarea>
                        <div class="flex gap-2">
                            <button id="save-btn" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save</button>
                            <button id="load-btn" class="w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Load</button>
                        </div>
                    </div>
                </div>
                 <div>
                    <button id="settings-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Settings</button>
                </div>
            </div>
        </aside>

        <!-- Main Content: Story & Input -->
        <main class="w-full md:w-1/2 flex flex-col h-[60vh] md:h-screen bg-gray-900 order-first md:order-none">
            <div id="story-container" class="flex-grow p-6 overflow-y-auto">
                <h1 class="font-title text-4xl text-center text-yellow-400 mb-6">Britannia 60 AD</h1>
                <div id="story-content" class="text-lg leading-relaxed">
                    <!-- Story content will be rendered here -->
                </div>
            </div>
            <div class="p-4 bg-gray-800 border-t border-gray-700">
                <form id="action-form" class="flex items-center gap-4">
                    <input type="text" id="action-input" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="What do you do?">
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors">Send</button>
                </form>
            </div>
        </main>

        <!-- Right Sidebar: Key Characters & Factions -->
        <aside class="w-full md:w-1/4 bg-gray-800 p-4 overflow-y-auto h-[40vh] md:h-screen">
            <div class="flex border-b-2 border-gray-700 mb-4">
                <div id="tab-character" class="sidebar-tab active">Character</div>
                <div id="tab-known-characters" class="sidebar-tab">Known NPCs</div>
                <div id="tab-factions" class="sidebar-tab">Factions</div>
                <div id="tab-console" class="sidebar-tab">Console</div>
            </div>
            <div id="character-panel" class="overflow-y-auto h-full"></div>
            <div id="known-characters-panel" class="overflow-y-auto h-full hidden"></div>
            <div id="factions-panel" class="overflow-y-auto h-full hidden"></div>
            <div id="console-panel" class="overflow-y-auto h-full hidden text-xs font-mono"></div>
        </aside>

    </div>
    
    <!-- Start Screen Modal -->
    <div id="start-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full text-white text-center">
            <h1 class="font-title text-5xl text-yellow-400 mb-4">Britannia 60 AD</h1>
            <p class="mb-6">To play, please enter your Gemini API Key. It will be saved locally in your browser and will not be shared.</p>
            <div class="mb-4">
                 <input type="password" id="api-key-input" class="w-full bg-gray-700 rounded px-3 py-2 text-center" placeholder="Enter your Gemini API Key">
            </div>
            <button id="continue-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mb-4 disabled:bg-gray-600 disabled:cursor-not-allowed">Continue Game</button>
            <button id="new-game-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors">New Game</button>
            <div class="mt-6">
                <a href="#" id="clear-data-btn" class="text-xs text-gray-500 hover:text-red-400 underline">Clear all local data (API Key & Saved Game)</a>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden overflow-y-auto p-4">
        <div class="bg-gray-800 p-8 rounded-lg max-w-4xl w-full text-white">
            <h2 class="font-title text-3xl mb-4 text-yellow-400 text-center">Character Creation</h2>
            
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-2/3">
                    <!-- Page 1: Appearance -->
                    <div id="creation-page-1" class="creation-page">
                        <h3 class="font-bold text-lg mb-2 text-yellow-300">Step 1: Appearance</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div><label for="char-name" class="block mb-1">Name:</label><input type="text" id="char-name" class="w-full bg-gray-700 rounded px-3 py-2" value="Character"></div>
                            <div><label class="block mb-1">Gender:</label><div class="flex items-center h-full gap-4"><label><input type="radio" name="gender" value="Male" class="mr-2">Male</label><label><input type="radio" name="gender" value="Female" class="mr-2">Female</label></div></div>
                            <div><label for="char-height" class="block mb-1">Height:</label><input type="text" id="char-height" class="w-full bg-gray-700 rounded px-3 py-2" placeholder="e.g., 6'1&quot;"></div>
                            <div><label for="char-weight" class="block mb-1">Weight:</label><input type="text" id="char-weight" class="w-full bg-gray-700 rounded px-3 py-2" placeholder="e.g., 180 lbs"></div>
                            <div><label for="char-build" class="block mb-1">Build:</label><select id="char-build" class="w-full bg-gray-700 rounded px-3 py-2"><option>Slender</option><option>Athletic</option><option>Average</option><option>Stocky</option><option>Heavyset</option></select></div>
                            <div><label for="char-skin" class="block mb-1">Skin Color:</label><select id="char-skin" class="w-full bg-gray-700 rounded px-3 py-2"><option>Fair</option><option>Light</option><option>Tan</option><option>Olive</option><option>Brown</option><option>Dark</option></select></div>
                            <div><label for="char-hair-style" class="block mb-1">Hair Style:</label><select id="char-hair-style" class="w-full bg-gray-700 rounded px-3 py-2"><option>Short</option><option>Medium</option><option>Long</option><option>Bald</option><option>Braided</option><option>Undercut</option></select></div>
                            <div><label for="char-hair-color" class="block mb-1">Hair Color:</label><select id="char-hair-color" class="w-full bg-gray-700 rounded px-3 py-2"><option>Black</option><option>Brown</option><option>Blonde</option><option>Red</option><option>Grey</option><option>White</option></select></div>
                            <div><label for="char-eye-color" class="block mb-1">Eye Color:</label><select id="char-eye-color" class="w-full bg-gray-700 rounded px-3 py-2"><option>Brown</option><option>Blue</option><option>Green</option><option>Hazel</option><option>Grey</option></select></div>
                        </div>
                        <div><label for="char-details" class="block mb-1">Additional Details:</label><textarea id="char-details" class="w-full bg-gray-700 rounded px-3 py-2" rows="3" placeholder="e.g., A long scar across his left cheek, sharp jawline, etc."></textarea></div>
                    </div>

                    <!-- Page 2: Abilities -->
                    <div id="creation-page-2" class="creation-page hidden">
                        <h3 class="font-bold text-lg mb-2 text-yellow-300">Step 2: Abilities</h3>
                        <div class="mb-4"><label class="block mb-2" data-info="attributes">Strongest Attribute (+25 bonus):</label><select id="attr-bonus" class="w-full bg-gray-700 rounded px-3 py-2"><option value="None">None</option><option value="STR">Strength (STR)</option><option value="DEX">Dexterity (DEX)</option><option value="WITS" selected>Wits (WITS)</option><option value="CHA">Charisma (CHA)</option></select></div>
                        <div class="mb-4"><label class="block mb-2" data-info="core_skills">Core Skills (Choose up to 3):</label><div id="core-skills-selection" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div></div>
                        <div class="mb-4"><label class="block mb-2" data-info="languages">Starting Languages:</label><div class="grid grid-cols-2 gap-4"><div><label for="lang-brittonic" class="block mb-1">Common Brittonic</label><select id="lang-brittonic" class="w-full bg-gray-700 rounded px-3 py-2"><option value="0">None (0%)</option><option value="25">Basic (25%)</option><option value="50">Conversational (50%)</option><option value="75" selected>Fluent (75%)</option><option value="100">Native (100%)</option></select></div><div><label for="lang-latin" class="block mb-1">Vulgar Latin</label><select id="lang-latin" class="w-full bg-gray-700 rounded px-3 py-2"><option value="0">None (0%)</option><option value="25">Basic (25%)</option><option value="50">Conversational (50%)</option><option value="75" selected>Fluent (75%)</option><option value="100">Native (100%)</option></select></div></div></div>
                    </div>

                    <!-- Page 3: Inventory -->
                    <div id="creation-page-3" class="creation-page hidden">
                        <h3 class="font-bold text-lg mb-2 text-yellow-300">Step 3: Starting Gear</h3>
                        <div class="mb-4 p-2 bg-gray-700 rounded"><label class="flex items-center"><input type="checkbox" id="terminator-mode" class="mr-3 h-5 w-5">Arrive with nothing (Hard Mode)</label><p class="text-xs text-gray-400 mt-1">This will increase difficulty. Locals may react negatively, and you will be exposed to the elements.</p></div>
                        <div id="gear-selection"></div>
                    </div>
                    
                    <!-- Page 4: Starting Location -->
                    <div id="creation-page-4" class="creation-page hidden">
                        <h3 class="font-bold text-lg mb-2 text-yellow-300">Step 4: Arrival</h3>
                         <p class="mb-4 text-gray-300">How do you arrive in this new time?</p>
                         <div class="space-y-3">
                            <div><label><input type="radio" name="start-location" value="wilderness" class="mr-2" checked>In a remote wilderness, alone and unseen.</label></div>
                            <div><label><input type="radio" name="start-location" value="roman_city" class="mr-2">In the bustling streets of a random Roman city.</label></div>
                            <div><label><input type="radio" name="start-location" value="tribal_holding" class="mr-2">In the heart of a random Celtic tribal holding.</label></div>
                         </div>
                    </div>
                </div>
                <div class="w-full md:w-1/3 info-box p-4 rounded-lg mt-4 md:mt-0">
                    <div id="info-box-content"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-6 flex justify-between">
                <button id="prev-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hidden">Back</button>
                <button id="next-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-6 rounded-lg transition-colors ml-auto">Next</button>
                <button id="create-char-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors ml-auto hidden">Begin Journey</button>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg max-w-lg w-full text-white">
            <h2 class="font-title text-3xl mb-6 text-yellow-400">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="settings-api-key" class="block mb-2">API Key:</label>
                    <input type="password" id="settings-api-key" class="w-full bg-gray-700 rounded px-3 py-2">
                </div>
                <div>
                    <label for="settings-char-desc" class="block mb-2">Edit Character Appearance:</label>
                    <textarea id="settings-char-desc" class="w-full bg-gray-700 rounded px-3 py-2" rows="4"></textarea>
                </div>
                <div>
                    <button id="return-to-start-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Return to Start Screen (Lose Unsaved Progress)</button>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="settings-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                <button id="settings-apply-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Apply & Close</button>
            </div>
        </div>
    </div>


    <script>
        // --- CORE GAME DATA & STATE MANAGEMENT (GLOBAL VARIABLES) ---
        
        let gameState = {};
        let turnCounter = 0;
        let apiKey = '';
        let coreRulesText = '';
        let scenarioData = {};
        let creationPage = 1;

        // --- ALL FUNCTION DEFINITIONS (DEFINED FIRST TO PREVENT ERRORS) ---

        function rollDice(count, sides) {
            let total = 0;
            for (let i = 0; i < count; i++) total += Math.floor(Math.random() * sides) + 1;
            return total;
        }

        function mergeDeep(target, source) {
            const output = { ...target };
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target))
                            Object.assign(output, { [key]: source[key] });
                        else
                            output[key] = mergeDeep(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }
        
        async function loadGameData() {
            const rulesResponse = await fetch('./CoreRules.json');
            if (!rulesResponse.ok) throw new Error('Could not load CoreRules.json');
            coreRulesText = await rulesResponse.text();

            const scenarioResponse = await fetch('./Scenario.json');
            if (!scenarioResponse.ok) throw new Error('Could not load Scenario.json');
            scenarioData = await scenarioResponse.json();
        }

        function initializeStartScreen() {
            const continueBtn = document.getElementById('continue-game-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const clearDataBtn = document.getElementById('clear-data-btn');

            const savedApiKey = localStorage.getItem('rpgApiKey');
            if (savedApiKey) apiKeyInput.value = savedApiKey;
            
            const savedGame = localStorage.getItem('rpgGameState');
            const hasValidSave = savedGame && JSON.parse(savedGame).turnCounter > 0;

            if (hasValidSave) {
                continueBtn.disabled = false;
                continueBtn.addEventListener('click', () => {
                    if (setApiKey()) loadGameFromLocalStorage();
                });
            } else {
                continueBtn.disabled = true;
            }
            
            newGameBtn.addEventListener('click', () => {
                if (hasValidSave) {
                    if (confirm('Starting a new game will delete your previous locally stored game files. Are you sure?')) {
                         if (setApiKey()) showSetupModal();
                    }
                } else {
                    if (setApiKey()) showSetupModal();
                }
            });
            
            clearDataBtn.addEventListener('click', clearLocalStorage);
            
            document.getElementById('action-form').addEventListener('submit', handlePlayerAction);
            document.getElementById('save-btn').addEventListener('click', handleSave);
            document.getElementById('load-btn').addEventListener('click', handleLoad);
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
            
            document.getElementById('tab-character').addEventListener('click', () => switchTab('character'));
            document.getElementById('tab-known-characters').addEventListener('click', () => switchTab('known-characters'));
            document.getElementById('tab-factions').addEventListener('click', () => switchTab('factions'));
            document.getElementById('tab-console').addEventListener('click', () => switchTab('console'));
        }

        function setApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const key = apiKeyInput.value.trim();
            if (!key) {
                alert('Please enter a valid API Key to continue.');
                return false;
            }
            apiKey = key;
            localStorage.setItem('rpgApiKey', key);
            return true;
        }

        function showSetupModal() {
            localStorage.removeItem('rpgGameState');

            document.getElementById('start-modal').classList.add('hidden');
            const modal = document.getElementById('setup-modal');
            const skillsContainer = document.getElementById('core-skills-selection');
            const gearContainer = document.getElementById('gear-selection');
            skillsContainer.innerHTML = ''; 
            gearContainer.innerHTML = '';
            
            scenarioData.available_skills.forEach(skill => {
                skillsContainer.innerHTML += `<div><label data-info="${skill.toLowerCase().replace(/\s/g, '_').replace(/[()]/g, '')}"><input type="checkbox" id="skill-${skill.toLowerCase()}" value="${skill}" class="skill-checkbox mr-2">${skill}</label></div>`;
            });
            
            Object.entries(scenarioData.starting_gear_options).forEach(([category, items]) => {
                let itemsHTML = items.map(item => `
                    <div class="ml-4"><label><input type="checkbox" class="gear-checkbox" value="${item}"> ${item}</label></div>
                `).join('');
                gearContainer.innerHTML += `<details class="mb-2" open><summary class="font-bold cursor-pointer">${category}</summary>${itemsHTML}</details>`;
            });

            document.querySelectorAll('.skill-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
                    if (checkedCount > 3) {
                        alert('You can only select up to 3 core skills.');
                        checkbox.checked = false;
                    }
                });
            });
            
            document.getElementById('terminator-mode').addEventListener('change', (e) => {
                 document.querySelectorAll('.gear-checkbox').forEach(cb => {
                    cb.disabled = e.target.checked;
                    if(e.target.checked) cb.checked = false;
                 });
            });

            modal.classList.remove('hidden');
            setupInfoBoxListeners();
            setupCreationNav();
        }
        
        function setupCreationNav() {
            document.getElementById('next-btn').addEventListener('click', () => navigateCreation(1));
            document.getElementById('prev-btn').addEventListener('click', () => navigateCreation(-1));
            document.getElementById('create-char-btn').addEventListener('click', createCharacter);
        }

        function navigateCreation(direction) {
            if (direction > 0 && creationPage === 2) {
                const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
                if (checkedCount > 3) {
                    alert('You can select a maximum of 3 core skills.');
                    return;
                }
            }

            document.getElementById(`creation-page-${creationPage}`).classList.add('hidden');
            creationPage += direction;
            document.getElementById(`creation-page-${creationPage}`).classList.remove('hidden');

            document.getElementById('prev-btn').classList.toggle('hidden', creationPage === 1);
            document.getElementById('next-btn').classList.toggle('hidden', creationPage === 4);
            document.getElementById('create-char-btn').classList.toggle('hidden', creationPage !== 4);
        }

        function setupInfoBoxListeners() {
            const infoBox = document.getElementById('info-box-content');
            const infoContent = {
                default: `<h3>Information</h3><p>Hover over an item on the left to learn more about it.</p>`,
                attributes: `<h3>Attributes</h3><p>Your four core stats. They determine your raw, untrained potential. Choosing a strongest attribute gives a +25 bonus to its starting roll.</p>`,
                core_skills: `<h3>Core Skills</h3><p>Your primary talents. You can choose up to 3. They start with a higher value (+25 bonus) and represent what your character is naturally good at.</p>`,
                languages: `<h3>Languages</h3><p>Your starting fluency. Higher fluency makes communication easier and opens up more social options.</p>`,
                athleticism: `<h3>Athleticism</h3><p>Governs physical prowess like running, jumping, and swimming. Increases your daily travel distance on foot.</p>`,
                survival: `<h3>Survival</h3><p>Your ability to find food, water, and shelter in the wild. Essential for staying alive outside of settlements.</p>`,
                improvisation: `<h3>Improvisation</h3><p>The skill of creating tools and solutions from available materials, heavily influenced by your modern knowledge.</p>`,
                stealth: `<h3>Stealth</h3><p>Allows you to move unseen and unheard, useful for avoiding conflict or gaining a tactical advantage.</p>`,
                first_aid: `<h3>First Aid</h3><p>Your ability to treat wounds and injuries. Can be significantly boosted by applying correct modern medical knowledge.</p>`,
                observation: `<h3>Observation</h3><p>Your ability to notice fine details, spot ambushes, or discern if someone is lying.</p>`,
                melee_improvised: `<h3>Melee (Improvised)</h3><p>Fighting with whatever you can find, from your pen knife to a tree branch. Represents untrained close-quarters combat.</p>`,
                unarmed_combat: `<h3>Unarmed Combat</h3><p>Your skill in hand-to-hand fighting, using fists, feet, and grappling.</p>`,
                ranged_combat: `<h3>Ranged Combat</h3><p>Your proficiency with projectile weapons like bows, slings, or even a modern firearm.</p>`,
                tactics: `<h3>Tactics</h3><p>Your understanding of battlefield strategy. Can be used to command others or gain an advantage in a fight.</p>`,
                lore: `<h3>Lore</h3><p>Knowledge of history, local customs, and beliefs. Crucial for navigating the complex social and political landscape.</p>`
            };
            
            infoBox.innerHTML = infoContent.default;

            document.querySelectorAll('[data-info]').forEach(el => {
                el.addEventListener('mouseenter', () => {
                    infoBox.innerHTML = infoContent[el.dataset.info] || infoContent.default;
                });
            });
        }

        function createCharacter() {
            // This function now needs to build the initial gameState from scratch
            let newGameState = {};
            
            const name = document.getElementById('char-name').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const height = document.getElementById('char-height').value;
            const weight = document.getElementById('char-weight').value;
            const build = document.getElementById('char-build').value;
            const skin = document.getElementById('char-skin').value;
            const hairStyle = document.getElementById('char-hair-style').value;
            const hairColor = document.getElementById('char-hair-color').value;
            const eyeColor = document.getElementById('char-eye-color').value;
            const details = document.getElementById('char-details').value;
            
            const bonusAttr = document.getElementById('attr-bonus').value;
            const selectedSkills = Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(cb => cb.value);
            const brittonicFluency = parseInt(document.getElementById('lang-brittonic').value, 10);
            const latinFluency = parseInt(document.getElementById('lang-latin').value, 10);

            const terminatorMode = document.getElementById('terminator-mode').checked;
            const selectedGear = terminatorMode ? [] : Array.from(document.querySelectorAll('.gear-checkbox:checked')).map(cb => cb.value);

            const startLocation = document.querySelector('input[name="start-location"]:checked').value;
            
            if (!name || !gender || !height || !weight) {
                alert('Please ensure all fields on Page 1 are complete.');
                navigateCreation(1 - creationPage);
                return;
            }

            // Assemble the description string
            const physicalDescription = `Gender: ${gender}. ${height}, ${weight}, ${build} build. ${hairColor} ${hairStyle} hair, ${eyeColor} eyes, and ${skin} skin. ${details}`;

            // Build the gameState object
            newGameState.turnCounter = 1;
            newGameState.characterSheet = {
                name: name,
                physicalDescription: physicalDescription,
                health: "Healthy",
                survivalStatus: "Sated, Hydrated, Warm",
                attributes: {},
                skills: {},
                languages: { "Common Brittonic": brittonicFluency, "Vulgar Latin": latinFluency },
                inventory: { currency: 0, items: selectedGear },
                location: "Parisi Territory",
                factionReputation: {}
            };
            newGameState.playerKnowledge = { knownCharacters: {}, knownFactions: {} };
            newGameState.worldState = { currentDate: "60.03.03", currentTime: "16:00", majorEvents: ["Arrived in the territory of the Parisi."] };
            newGameState.keyCharacters = scenarioData.initial_key_characters;
            newGameState.factions = scenarioData.faction_data;
            
            Object.keys(newGameState.factions).forEach(f => {
                newGameState.characterSheet.factionReputation[f] = 0;
            });

            ['STR', 'DEX', 'WITS', 'CHA'].forEach(attr => {
                let roll = rollDice(5, 20);
                if (attr === bonusAttr) roll += 25;
                newGameState.characterSheet.attributes[attr] = Math.min(100, roll);
            });

            scenarioData.available_skills.forEach(skill => {
                let roll = selectedSkills.includes(skill) ? rollDice(3, 20) + 25 : rollDice(3, 20);
                newGameState.characterSheet.skills[skill] = { value: roll, type: selectedSkills.includes(skill) ? 'core' : 'other' };
            });

            gameState = newGameState;

            let startingMessage = scenarioData.starting_situations[startLocation] || scenarioData.starting_situations.wilderness;
            
            if(startLocation === 'roman_city') {
                const cities = ["Camulodunum", "Londinium", "Verulamium"];
                const city = cities[Math.floor(Math.random() * cities.length)];
                startingMessage = startingMessage.replace('[CITY]', city);
                gameState.characterSheet.location = city;
            } else if (startLocation === 'tribal_holding') {
                const holdings = ["the Iceni capital", "the Parisi capital", "Stanwick, the Brigante capital"];
                const holding = holdings[Math.floor(Math.random() * holdings.length)];
                startingMessage = startingMessage.replace('[HOLDING]', holding);
                gameState.characterSheet.location = holding;
            }

            startGame(startingMessage);
        }

        function startGame(startingMessage) {
            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            turnCounter = gameState.turnCounter || 1;
            updateUI();
            addStoryMessage(startingMessage, "GM");
        }

        // --- UI & RENDER FUNCTIONS ---
        function renderFactions() {
            const display = document.getElementById('factions-panel');
            const factions = gameState.factions || {};
             display.innerHTML = Object.keys(factions).map(name => `
                <div class="mb-2 text-sm p-2 bg-gray-700 rounded">
                    <p><strong>${name}:</strong> ${gameState.characterSheet.factionReputation[name] || 0} Rep</p>
                </div>
            `).join('');
        }
        
        function renderKeyCharacters() {
            const display = document.getElementById('known-characters-panel');
            const knownChars = gameState.playerKnowledge.knownCharacters || {};
            if (Object.keys(knownChars).length === 0) {
                display.innerHTML = `<p class="text-gray-500 italic">You have not met any key characters yet.</p>`;
                return;
            }
            display.innerHTML = Object.entries(knownChars).map(([name, data]) => `
                <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <h3 class="font-title text-lg text-yellow-400">${name}</h3>
                    ${data.description ? `<p class="text-sm"><strong>Known Info:</strong> ${data.description}</p>` : ''}
                    ${data.status ? `<p class="text-sm"><strong>Status:</strong> ${data.status}</p>` : ''}
                </div>
            `).join('');
        }
        
        function renderCharacterPanel() {
            const display = document.getElementById('character-panel');
            const pc = gameState.characterSheet;
            let inventoryHTML = pc.inventory.items.map(item => `<li>${item}</li>`).join('');
            display.innerHTML = `
                <div class="space-y-4">
                    <div><h3 class="font-title text-xl text-yellow-400">${pc.name}</h3><p class="text-sm italic">${pc.physicalDescription}</p></div>
                    <div><p><strong>Health:</strong> <span class="text-green-400">${pc.health}</span></p><p><strong>Status:</strong> ${pc.survivalStatus}</p></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Inventory</h4><ul class="text-sm"><li>${pc.inventory.currency} Denarii</li>${inventoryHTML}</ul></div>
                </div>
            `;
        }

        function renderGameState() {
            const display = document.getElementById('game-state-display');
            const pc = gameState.characterSheet;
            
            let skillsHTML = Object.entries(pc.skills).map(([name, data]) => 
                `<li class="${data.type === 'core' ? 'text-yellow-400' : ''}">${name}: ${data.value}</li>`
            ).join('');

            let languagesHTML = Object.entries(pc.languages).map(([name, fluency]) =>
                `<li>${name}: ${fluency}%</li>`
            ).join('');

            display.innerHTML = `
                <div class="space-y-4">
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Attributes</h4><ul class="text-sm"><li>STR: ${pc.attributes.STR}</li><li>DEX: ${pc.attributes.DEX}</li><li>WITS: ${pc.attributes.WITS}</li><li>CHA: ${pc.attributes.CHA}</li></ul></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Skills</h4><ul class="text-sm">${skillsHTML}</ul></div>
                    <div><h4 class="font-bold border-b border-gray-600 mb-1">Languages</h4><ul class="text-sm">${languagesHTML}</ul></div>
                </div>
            `;
        }
        
        function updateUI() {
            renderGameState();
            renderKeyCharacters();
            renderFactions();
            renderCharacterPanel();
        }
        
        function addStoryMessage(html, sender="GM") {
            const content = document.getElementById('story-content');
            const messageDiv = document.createElement('div');
            
            if (sender === "Player") {
                messageDiv.className = 'text-right mb-4';
                messageDiv.innerHTML = `<div class="bg-yellow-700 inline-block p-3 rounded-lg text-left"><em>${html}</em></div>`;
            } else {
                const header = document.createElement('p');
                header.className = 'text-sm text-yellow-300 font-title';
                header.textContent = `[Turn ${turnCounter} | ${gameState.worldState.currentDate} | ${gameState.worldState.currentTime}]`;
                content.appendChild(header);
                
                messageDiv.className = 'mb-4';
                messageDiv.innerHTML = html;
            }
            
            content.appendChild(messageDiv);
            document.getElementById('story-container').scrollTop = document.getElementById('story-container').scrollHeight;
        }

        function logToConsole(message, data) {
            const consolePanel = document.getElementById('console-panel');
            const entry = document.createElement('div');
            entry.className = 'mb-2 p-2 bg-gray-700 rounded';
            let content = `<strong>${message}</strong>`;
            if (data) {
                content += `<pre class="whitespace-pre-wrap text-xs">${JSON.stringify(data, null, 2)}</pre>`;
            }
            entry.innerHTML = content;
            consolePanel.appendChild(entry);
            consolePanel.scrollTop = consolePanel.scrollHeight;
        }

        // --- GAME LOGIC ---

        async function handlePlayerAction(event) {
            event.preventDefault();
            const input = document.getElementById('action-input');
            const actionText = input.value.trim();
            if (!actionText) return;

            addStoryMessage(actionText, "Player");
            input.value = '';
            input.disabled = true;
            document.querySelector('#action-form button').disabled = true;

            const fullPrompt = constructFullPrompt(actionText);
            logToConsole('Sending Prompt to API...', { promptLength: fullPrompt.length });
            const apiResponse = await callGeminiAPI(fullPrompt);
            logToConsole('Received Response from API:', apiResponse);
            
            processApiResponse(apiResponse);

            turnCounter++;
            gameState.turnCounter = turnCounter;
            
            saveGameToLocalStorage();
            updateUI();
            
            input.disabled = false;
            document.querySelector('#action-form button').disabled = false;
            input.focus();
        }

        function processApiResponse(response) {
            if (response.stateChanges) {
                gameState = mergeDeep(gameState, response.stateChanges);
            }
            addStoryMessage(response.narrative, "GM");
        }
        
        // --- SAVE / LOAD LOGIC ---

        function saveGameToLocalStorage() {
            localStorage.setItem('rpgGameState', JSON.stringify(gameState));
        }

        function loadGameFromLocalStorage() {
            const savedGame = localStorage.getItem('rpgGameState');
            if (savedGame) {
                gameState = JSON.parse(savedGame);
                const lastEvent = gameState.worldState.majorEvents[gameState.worldState.majorEvents.length - 1] || "your journey";
                startGame(`Game loaded. You continue ${lastEvent}.`);
            }
        }

        function handleSave() {
            const jsonString = JSON.stringify(gameState);
            const base64String = btoa(jsonString);
            const textArea = document.getElementById('save-load-data');
            textArea.value = base64String;
            textArea.select();
            document.execCommand('copy');
            alert('Backup code copied to clipboard!');
        }
        
        function handleLoad() {
            const textArea = document.getElementById('save-load-data');
            loadGameFromCode(textArea.value);
        }

        function loadGameFromCode(saveCode) {
            if (!saveCode.trim()) {
                alert('Please paste a save code into the text area first.');
                return;
            }
            try {
                const jsonString = atob(saveCode);
                const loadedData = JSON.parse(jsonString);

                if (loadedData.characterSheet) {
                    gameState = loadedData;
                    document.getElementById('story-content').innerHTML = '';
                    const lastEvent = gameState.worldState.majorEvents[gameState.worldState.majorEvents.length - 1] || "your journey";
                    startGame(`Game loaded from code. You continue ${lastEvent}.`);
                } else {
                    throw new Error('Invalid save file structure.');
                }
            } catch (error) {
                console.error("Failed to load game:", error);
                alert('Failed to load game. The save code appears to be invalid or corrupted.');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('rpgGameState');
            localStorage.removeItem('rpgApiKey');
            document.getElementById('api-key-input').value = '';
            document.getElementById('continue-game-btn').disabled = true;
            alert('All local data has been cleared.');
        }

        // --- MODAL & UI LOGIC ---

        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            document.getElementById('settings-api-key').value = apiKey;
            document.getElementById('settings-char-desc').value = gameState.characterSheet.physicalDescription;
            modal.classList.remove('hidden');
            
            document.getElementById('settings-apply-btn').onclick = applySettings;
            document.getElementById('settings-cancel-btn').onclick = () => modal.classList.add('hidden');
            document.getElementById('return-to-start-btn').onclick = () => window.location.reload();
        }

        function applySettings() {
            const newApiKey = document.getElementById('settings-api-key').value.trim();
            const newDesc = document.getElementById('settings-char-desc').value.trim();

            if (newApiKey) {
                apiKey = newApiKey;
                localStorage.setItem('rpgApiKey', apiKey);
            }
            if (newDesc) {
                gameState.characterSheet.physicalDescription = newDesc;
            }
            
            saveGameToLocalStorage();
            updateUI();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function switchTab(tabName) {
            ['character', 'known-characters', 'factions', 'console'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`${t}-panel`).classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');
        }

        // --- API & DATA PARSING ---

        function constructFullPrompt(playerAction) {
            const gameStateString = JSON.stringify(gameState, null, 2);
            return `
                --- CORE RULES ---
                ${coreRulesText}

                --- SCENARIO CONTEXT ---
                ${JSON.stringify(scenarioData, null, 2)}

                --- CURRENT GAME STATE (JSON) ---
                ${gameStateString}

                --- PLAYER ACTION ---
                ${playerAction}
            `;
        }

        async function callGeminiAPI(prompt) {
            if (!apiKey) {
                alert("API Key is not set. Please refresh and enter your key.");
                return { narrative: `<p class="text-red-400">Error: API Key is missing.</p>`, stateChanges: {} };
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API call failed with status: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                const responseText = data.candidates[0].content.parts[0].text;
                return JSON.parse(responseText);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                logToConsole("API Error:", error.message);
                return {
                    narrative: `<p class="text-red-400">Error connecting to the AI. Please check the console for details.</p>`,
                    stateChanges: {}
                };
            }
        }
        
        // --- SCRIPT EXECUTION START ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadGameData();
                initializeStartScreen();
            } catch (error) {
                document.body.innerHTML = `<div class="text-red-400 p-8"><strong>Error loading game files:</strong> ${error.message}.<br><br>Please ensure <strong>CoreRules.json</strong> and <strong>Scenario.json</strong> are in the same folder as this index.html file.</div>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>
