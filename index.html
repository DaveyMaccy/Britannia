<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Britannia 60 AD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c0c;
        }
        .font-title {
            font-family: 'IM Fell English', serif;
        }
        /* OSRS-inspired UI theme */
        .panel, .modal-content {
            background-color: #2e2820;
            border: 4px solid #000;
            box-shadow: inset 0 0 0 2px #5a4a3a, 0 4px 6px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        .panel-header {
            color: #ff9900; /* OSRS yellow */
            text-shadow: 1px 1px #000;
        }
        .sidebar-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            color: #c7c7c7;
        }
        .sidebar-tab.active {
            border-color: #ff9900; /* OSRS yellow */
            color: #ff9900;
            background-color: rgba(255, 153, 0, 0.1);
        }
        /* Custom scrollbar for a more thematic feel */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #5a4a3a; border: 1px solid #000; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7a6a5a; }

        .story-content p { margin-bottom: 1rem; }
        .creation-page { max-height: 70vh; overflow-y: auto; padding-right: 1rem; }
        .info-box { background-color: #1a1a1a; border-left: 3px solid #ff9900; }
        .btn {
            background-color: #4a3a2a;
            border: 2px solid #000;
            color: #ff9900;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-shadow: 1px 1px #000;
            transition: background-color 0.2s;
        }
        .btn:hover:not(:disabled) { background-color: #6a5a4a; }
        .btn:disabled { background-color: #3a2a1a; color: #776; cursor: not-allowed; }
        input[type="text"], input[type="number"], select, textarea {
            background-color: #1a1a1a;
            border: 2px solid #5a4a3a;
            border-radius: 4px;
            padding: 0.5rem;
            color: #c7c7c7;
            width: 100%;
        }
        @keyframes pulse { 50% { opacity: 0.6; } }
        .animate-pulse-slow { animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Styles for the new file drop zone */
        .drop-zone {
            border: 2px dashed #5a4a3a;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: #7a6a5a;
            transition: background-color 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .drop-zone.drag-over {
            background-color: #3a2a1a;
            border-color: #ff9900;
        }
        .drop-zone input[type="file"] {
            display: none;
        }

        /* Styles for the custom UI message */
        .ui-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
            text-align: center;
        }
        .ui-message.show {
            opacity: 1;
        }
        .ui-message.error {
            background-color: #991b1b; /* red-800 */
            border: 2px solid #f87171; /* red-400 */
        }
        .ui-message.success {
            background-color: #065f46; /* green-800 */
            border: 2px solid #34d399; /* green-400 */
        }
    </style>
</head>
<body class="bg-black text-gray-300">

    <!-- Root container for the entire application -->
    <div id="root">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-black flex items-center justify-center z-50">
            <h1 class="font-title text-5xl text-yellow-400 animate-pulse-slow">Loading Game Data...</h1>
        </div>

        <!-- Start Screen Modal -->
        <div id="start-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
            <div class="modal-content w-full max-w-md p-6 space-y-4">
                <h1 class="font-title text-4xl text-center text-yellow-400">Britannia 60 AD</h1>
                <p class="text-center text-gray-400">Enter your Gemini API Key to begin.</p>
                <input type="text" id="api-key-input" placeholder="Enter your API Key" class="w-full text-center">
                <div class="grid grid-cols-2 gap-4">
                    <button id="continue-game-btn" class="btn w-full" disabled>Continue</button>
                    <button id="new-game-btn" class="btn w-full">New Game</button>
                </div>
                <button id="clear-data-btn" class="text-xs text-gray-500 hover:text-red-400 text-center w-full">Clear All Local Data</button>
            </div>
        </div>

        <!-- Character Creation Modal -->
        <div id="setup-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-30 p-4">
            <div class="modal-content w-full max-w-6xl h-full max-h-[90vh] flex flex-col p-6">
                <h2 class="font-title text-3xl text-yellow-400 text-center mb-4">Character Creation</h2>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-hidden">
                    <!-- Left Panel: Selections -->
                    <div class="md:col-span-2 creation-page" id="creation-panels">
                        <!-- Page 1: Appearance -->
                        <div id="creation-page-1">
                            <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 mb-2">Appearance</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                                <div><label for="char-name" class="text-sm text-gray-400">Name</label><input type="text" id="char-name" placeholder="An Unknown Wanderer"></div>
                                <div><label for="char-gender" class="text-sm text-gray-400">Gender</label><select id="char-gender"><option>Male</option><option>Female</option></select></div>
                                <div><label for="char-height" class="text-sm text-gray-400">Height</label><input type="text" id="char-height" placeholder="Average"></div>
                                <div><label for="char-weight" class="text-sm text-gray-400">Weight (lbs)</label><input type="text" id="char-weight" placeholder="Average"></div>
                                <div><label for="char-build" class="text-sm text-gray-400">Build</label><select id="char-build"><option>Body 1</option><option>Body 2</option><option>Body 3</option></select></div>
                                <div><label for="char-skin" class="text-sm text-gray-400">Skin Tone</label><select id="char-skin"><option>Light</option><option>Tan</option><option>Dark</option></select></div>
                                <div><label for="char-hair-style" class="text-sm text-gray-400">Hair Style</label><select id="char-hair-style"><option>None</option><option>Short</option><option>Medium</option><option>Long</option></select></div>
                                <div><label for="char-hair-color" class="text-sm text-gray-400">Hair Color</label><select id="char-hair-color"><option>Blonde</option><option>Red</option><option>Brown</option><option>Grey</option><option>Black</option></select></div>
                                <div><label for="char-eye-color" class="text-sm text-gray-400">Eye Color</label><select id="char-eye-color"><option>Blue</option><option>Green</option><option>Hazel</option><option>Brown</option></select></div>
                            </div>
                             <div class="mt-4"><label for="char-details" class="text-sm text-gray-400">Distinguishing Features</label><textarea id="char-details" placeholder="Scars, tattoos, etc... (or leave blank)" class="w-full h-24"></textarea></div>
                        </div>
                        <!-- Page 2: Attributes & Skills -->
                        <div id="creation-page-2" class="hidden">
                             <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 mb-2" data-info="attributes">Attributes</h3>
                             <p class="text-sm text-gray-400 mb-2">Choose your strongest attribute for a +25 bonus.</p>
                             <div class="info-box p-3 rounded mb-4 text-xs space-y-1">
                                 <p><strong>Strength (STR):</strong> Raw physical power, affecting melee damage and carrying capacity.</p>
                                 <p><strong>Dexterity (DEX):</strong> Agility, reflexes, and precision, affecting ranged combat and stealth.</p>
                                 <p><strong>Wits (WITS):</strong> Intelligence, perception, and problem-solving, affecting skills like First Aid and Tactics.</p>
                                 <p><strong>Charisma (CHA):</strong> Force of personality, persuasiveness, and leadership.</p>
                             </div>
                             <select id="attr-bonus" class="w-full mb-4">
                                <option value="STR">Strength (STR)</option>
                                <option value="DEX">Dexterity (DEX)</option>
                                <option value="WITS">Wits (WITS)</option>
                                <option value="CHA">Charisma (CHA)</option>
                             </select>
                             <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 mb-2" data-info="core_skills">Core Skills</h3>
                             <p class="text-sm text-gray-400 mb-2">Choose up to 3 core skills for a +25 bonus.</p>
                             <div id="core-skills-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        </div>
                        <!-- Page 3: Gear & Languages -->
                        <div id="creation-page-3" class="hidden">
                            <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 mb-2">Starting Gear</h3>
                            <label class="flex items-center mb-2"><input type="checkbox" id="terminator-mode" class="mr-2"> Terminator Mode (No Gear)</label>
                            <div id="gear-selection" class="space-y-2"></div>
                            <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 my-4" data-info="languages">Languages</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label>Common Brittonic Fluency</label><input type="number" id="lang-brittonic" value="100" min="0" max="100"></div>
                                <div><label>Vulgar Latin Fluency</label><input type="number" id="lang-latin" value="100" min="0" max="100"></div>
                            </div>
                        </div>
                        <!-- Page 4: Scenario Start -->
                        <div id="creation-page-4" class="hidden">
                            <h3 class="font-title text-xl text-yellow-400 border-b border-gray-600 mb-2">Starting Situation</h3>
                            <div class="space-y-2">
                                <div><label><input type="radio" name="start-location" value="wilderness" checked> Lost in the Wilderness</label></div>
                                <div><label><input type="radio" name="start-location" value="roman_city"> Waking up in a Roman City</label></div>
                                <div><label><input type="radio" name="start-location" value="tribal_holding"> On the edge of a Tribal Holding</label></div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Panel: Info Box -->
                    <div class="info-box p-4 rounded-lg h-full">
                        <div id="info-box-content"></div>
                    </div>
                </div>
                <!-- Navigation -->
                <div class="flex justify-between items-center pt-4 mt-4 border-t border-gray-600">
                    <button id="prev-btn" class="btn hidden">Previous</button>
                    <div class="flex-grow"></div>
                    <button id="next-btn" class="btn">Next</button>
                    <button id="create-char-btn" class="btn hidden">Create Character</button>
                </div>
            </div>
        </div>

        <!-- Main Application Container -->
        <div id="app-container" class="hidden h-screen w-screen p-4 flex flex-col md:flex-row gap-4">
            <!-- Left Panel: Story -->
            <div class="flex-grow flex flex-col h-1/2 md:h-full md:w-2/3 panel">
                <div class="panel-header p-2 text-center text-lg">Story Log</div>
                <div id="story-container" class="flex-grow p-4 overflow-y-auto">
                    <div id="story-content"></div>
                </div>
                <form id="action-form" class="p-2 border-t-4 border-black flex gap-2">
                    <input type="text" id="action-input" class="flex-grow" placeholder="What do you do?">
                    <button type="submit" class="btn">Send</button>
                </form>
            </div>
            <!-- Right Panel: Character Info -->
            <div class="h-1/2 md:h-full md:w-1/3 flex flex-col panel">
                <div class="flex border-b-4 border-black">
                    <div id="tab-character" class="sidebar-tab active flex-1 text-center">Character</div>
                    <div id="tab-known-characters" class="sidebar-tab flex-1 text-center">People</div>
                    <div id="tab-factions" class="sidebar-tab flex-1 text-center">Factions</div>
                    <div id="tab-console" class="sidebar-tab flex-1 text-center">Console</div>
                </div>
                <div class="flex-grow p-4 overflow-y-auto">
                    <div id="character-panel"></div>
                    <div id="known-characters-panel" class="hidden"></div>
                    <div id="factions-panel" class="hidden"></div>
                    <div id="console-panel" class="hidden text-xs space-y-2"></div>
                </div>
                 <div class="p-2 border-t-4 border-black flex gap-2">
                    <button id="settings-btn" class="btn w-full">Settings</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="modal-content w-full max-w-lg p-6 space-y-4">
                <h2 class="font-title text-2xl text-yellow-400">Settings</h2>
                <div><label>API Key</label><input type="text" id="settings-api-key" class="w-full"></div>
                <div><label>Character Description (for AI)</label><textarea id="settings-char-desc" class="w-full h-24"></textarea></div>
                <div class="flex justify-end gap-4">
                    <button id="settings-cancel-btn" class="btn">Cancel</button>
                    <button id="settings-apply-btn" class="btn">Apply</button>
                </div>
                <h3 class="font-title text-xl text-yellow-400 pt-4 border-t border-gray-600">Save/Load Game</h3>
                <button id="save-file-btn" class="btn w-full">Save Game to File</button>
                <div class="mt-4">
                    <label id="drop-zone-label" for="load-file-input" class="drop-zone block">
                        <span id="drop-zone-text">Drag & Drop Save File Here or Click to Browse</span>
                        <input type="file" id="load-file-input" accept=".json">
                    </label>
                </div>
                <button id="load-file-btn" class="btn w-full mt-2" disabled>Load Game from File</button>
                 <div class="pt-4 border-t border-gray-600 mt-4">
                     <button id="return-to-start-btn" class="btn bg-red-800 hover:bg-red-700 w-full">Return to Start Screen & Clear Game</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- II. ALL FUNCTION DEFINITIONS (DEFINED FIRST TO PREVENT ERRORS) ---
    // This section contains all the functions the application will use.
    // They are defined globally so they can be called from anywhere in the script
    // after this point.

    // --- CORE DATA & STATE MANAGEMENT ---
    let gameState = {};
    let turnCounter = 0;
    let apiKey = '';
    let coreRulesText = '';
    let scenarioData = {};
    let creationPage = 1;
    let fileToLoad = null; // Variable to hold the selected file for loading

    /**
     * Displays a temporary message to the user. Replaces the need for alert().
     * @param {string} message The text to display.
     * @param {string} type 'success' or 'error' for styling.
     */
    function showUIMessage(message, type = 'error') {
        const messageEl = document.createElement('div');
        messageEl.textContent = message;
        messageEl.className = `ui-message ${type}`;
        document.body.appendChild(messageEl);

        // Trigger the fade-in transition
        setTimeout(() => {
            messageEl.classList.add('show');
        }, 10);

        // Remove the message after a delay
        setTimeout(() => {
            messageEl.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 500); // Wait for fade-out to complete
        }, 3000);
    }
    
    /**
     * Fetches the core JSON files required for the game to run.
     * Throws an error if any file cannot be loaded.
     */
    async function loadGameData() {
        try {
            const rulesResponse = await fetch('./CoreRules.json');
            if (!rulesResponse.ok) throw new Error('Could not load CoreRules.json');
            coreRulesText = await rulesResponse.text();

            const scenarioResponse = await fetch('./Scenario.json');
            if (!scenarioResponse.ok) throw new Error('Could not load Scenario.json');
            scenarioData = await scenarioResponse.json();
        } catch (error) {
            console.error("Fatal Error during data load:", error);
            const root = document.getElementById('root');
            root.innerHTML = `<div class="text-red-400 p-8"><strong>Error loading game files:</strong> ${error.message}.<br><br>Please ensure <strong>CoreRules.json</strong> and <strong>Scenario.json</strong> are in the same folder as this index.html file and the server is running correctly.</div>`;
            throw error; // Stop execution
        }
    }

    // --- INITIALIZATION & SETUP ---

    /**
     * Sets up the initial start screen, loading data from localStorage
     * and attaching the primary event listeners for starting or continuing a game.
     */
    function initializeStartScreen() {
        const continueBtn = document.getElementById('continue-game-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        
        const savedApiKey = localStorage.getItem('rpgApiKey');
        if (savedApiKey) apiKeyInput.value = savedApiKey;
        
        const savedGame = localStorage.getItem('rpgGameState');
        const hasValidSave = savedGame && JSON.parse(savedGame).turnCounter > 0;

        continueBtn.disabled = !hasValidSave;
        
        // Show the start modal now that it's ready
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('start-modal').classList.remove('hidden');
    }
    
    /**
     * Validates and stores the API key from the input field.
     * @returns {boolean} True if the key is valid, false otherwise.
     */
    function setApiKey() {
        const apiKeyInput = document.getElementById('api-key-input');
        const key = apiKeyInput.value.trim();
        if (!key) {
            showUIMessage('Please enter a valid API Key to continue.');
            return false;
        }
        apiKey = key;
        localStorage.setItem('rpgApiKey', key);
        return true;
    }

    /**
     * Displays the character creation modal and populates it with data from Scenario.json.
     */
    function showSetupModal() {
        localStorage.removeItem('rpgGameState');

        document.getElementById('start-modal').classList.add('hidden');
        const modal = document.getElementById('setup-modal');
        const skillsContainer = document.getElementById('core-skills-selection');
        const gearContainer = document.getElementById('gear-selection');
        skillsContainer.innerHTML = ''; 
        gearContainer.innerHTML = '';
        
        // Populate Skills
        scenarioData.available_skills.forEach(skill => {
            const skillId = skill.toLowerCase().replace(/[\s()]/g, '_');
            skillsContainer.innerHTML += `
                <div>
                    <label class="flex items-center" data-info="${skillId}">
                        <input type="checkbox" value="${skill}" class="skill-checkbox mr-2">
                        ${skill}
                    </label>
                </div>`;
        });
        
        // Populate Gear
        Object.entries(scenarioData.starting_gear_options).forEach(([category, items]) => {
            let itemsHTML = items.map(item => `
                <div class="ml-4"><label><input type="checkbox" class="gear-checkbox" value="${item}"> ${item}</label></div>
            `).join('');
            gearContainer.innerHTML += `<details class="mb-2" open><summary class="font-bold cursor-pointer">${category}</summary><div class="p-2">${itemsHTML}</div></details>`;
        });

        // Add event listeners for skill checkboxes (limit to 3)
        document.querySelectorAll('.skill-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
                if (checkedCount > 3) {
                    showUIMessage('You can only select up to 3 core skills.');
                    checkbox.checked = false;
                }
            });
        });
        
        // Add event listener for terminator mode
        document.getElementById('terminator-mode').addEventListener('change', (e) => {
             document.querySelectorAll('.gear-checkbox').forEach(cb => {
                cb.disabled = e.target.checked;
                if(e.target.checked) cb.checked = false;
             });
        });

        modal.classList.remove('hidden');
        setupInfoBoxListeners();
    }

    /**
     * Sets up hover listeners for elements with `data-info` attributes to display
     * helpful information in the creation info box.
     */
    function setupInfoBoxListeners() {
        const infoBox = document.getElementById('info-box-content');
        const infoContent = {
            default: `<h3>Information</h3><p>Hover over an item on the left to learn more about it.</p>`,
            attributes: `<h3>Attributes</h3><p>Your four core stats. They determine your raw, untrained potential. Choosing a strongest attribute gives a +25 bonus to its starting roll.</p>`,
            core_skills: `<h3>Core Skills</h3><p>Your primary talents. You can choose up to 3. They start with a higher value (+25 bonus) and represent what your character is naturally good at.</p>`,
            languages: `<h3>Languages</h3><p>Your starting fluency. Higher fluency makes communication easier and opens up more social options.</p>`,
            athleticism: `<h3>Athleticism</h3><p>Governs physical prowess like running, jumping, and swimming. Increases your daily travel distance on foot.</p>`,
            survival: `<h3>Survival</h3><p>Your ability to find food, water, and shelter in the wild. Essential for staying alive outside of settlements.</p>`,
            improvisation: `<h3>Improvisation</h3><p>The skill of creating tools and solutions from available materials, heavily influenced by your modern knowledge.</p>`,
            stealth: `<h3>Stealth</h3><p>Allows you to move unseen and unheard, useful for avoiding conflict or gaining a tactical advantage.</p>`,
            first_aid: `<h3>First Aid</h3><p>Your ability to treat wounds and injuries. Can be significantly boosted by applying correct modern medical knowledge.</p>`,
            observation: `<h3>Observation</h3><p>Your ability to notice fine details, spot ambushes, or discern if someone is lying.</p>`,
            melee_improvised: `<h3>Melee (Improvised)</h3><p>Fighting with whatever you can find, from your pen knife to a tree branch. Represents untrained close-quarters combat.</p>`,
            unarmed_combat: `<h3>Unarmed Combat</h3><p>Your skill in hand-to-hand fighting, using fists, feet, and grappling.</p>`,
            ranged_combat: `<h3>Ranged Combat</h3><p>Your proficiency with projectile weapons like bows, slings, or even a modern firearm.</p>`,
            tactics: `<h3>Tactics</h3><p>Your understanding of battlefield strategy. Can be used to command others or gain an advantage in a fight.</p>`,
            lore: `<h3>Lore</h3><p>Knowledge of history, local customs, and beliefs. Crucial for navigating the complex social and political landscape.</p>`
        };
        
        infoBox.innerHTML = infoContent.default;

        document.querySelectorAll('[data-info]').forEach(el => {
            el.addEventListener('mouseenter', () => {
                const infoKey = el.dataset.info;
                infoBox.innerHTML = infoContent[infoKey] || infoContent.default;
            });
        });
    }

    /**
     * Handles the next/previous navigation in the character creation modal.
     * @param {number} direction - 1 for next, -1 for previous.
     */
    function navigateCreation(direction) {
        // Validation for skill count when leaving page 2
        if (direction > 0 && creationPage === 2) {
            const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
            if (checkedCount > 3) {
                showUIMessage('You can select a maximum of 3 core skills.');
                return; // Stop navigation
            }
        }

        document.getElementById(`creation-page-${creationPage}`).classList.add('hidden');
        creationPage += direction;
        document.getElementById(`creation-page-${creationPage}`).classList.remove('hidden');

        document.getElementById('prev-btn').classList.toggle('hidden', creationPage === 1);
        document.getElementById('next-btn').classList.toggle('hidden', creationPage === 4);
        document.getElementById('create-char-btn').classList.toggle('hidden', creationPage !== 4);
    }
    
    /**
     * Collects all data from the creation form, builds the initial gameState object,
     * and starts the game. This is only called from the "Create Character" button on the last page.
     */
    function createCharacter() {
        let newGameState = {};
        
        // Collect data from form, providing defaults for blank text fields
        const name = document.getElementById('char-name').value.trim() || "An Unknown Wanderer";
        const gender = document.getElementById('char-gender').value;
        const height = document.getElementById('char-height').value.trim() || "Average";
        const weight = document.getElementById('char-weight').value.trim() || "Average";
        const build = document.getElementById('char-build').value;
        const skin = document.getElementById('char-skin').value;
        const hairStyle = document.getElementById('char-hair-style').value;
        const hairColor = document.getElementById('char-hair-color').value;
        const eyeColor = document.getElementById('char-eye-color').value;
        const details = document.getElementById('char-details').value.trim() || "No distinguishing features noted.";
        const bonusAttr = document.getElementById('attr-bonus').value;
        const selectedSkills = Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(cb => cb.value);
        const brittonicFluency = parseInt(document.getElementById('lang-brittonic').value, 10);
        const latinFluency = parseInt(document.getElementById('lang-latin').value, 10);
        const terminatorMode = document.getElementById('terminator-mode').checked;
        
        // Determine gear. If terminator mode is off and no items are checked, it's still terminator mode.
        const gearCheckboxes = document.querySelectorAll('.gear-checkbox:checked');
        const selectedGear = (terminatorMode || gearCheckboxes.length === 0) ? [] : Array.from(gearCheckboxes).map(cb => cb.value);

        const startLocation = document.querySelector('input[name="start-location"]:checked').value;

        const physicalDescription = `Gender: ${gender}. ${height}, ${weight} lbs, ${build} build. ${hairColor} ${hairStyle} hair, ${eyeColor} eyes, and ${skin} skin. ${details}`;
        
        // Use the template from Scenario.json to build the initial state
        newGameState = JSON.parse(JSON.stringify(scenarioData.gameStateTemplate));

        // Populate the new game state
        newGameState.turnCounter = 1;
        newGameState.characterSheet.name = name;
        newGameState.characterSheet.physicalDescription = physicalDescription;
        newGameState.characterSheet.languages = { "Common Brittonic": brittonicFluency, "Vulgar Latin": latinFluency };
        newGameState.characterSheet.inventory.items = selectedGear;
        
        newGameState.keyCharacters = scenarioData.initial_key_characters;
        newGameState.factions = scenarioData.faction_data;
        
        Object.keys(newGameState.factions).forEach(f => {
            newGameState.characterSheet.factionReputation[f] = 0;
        });

        // Roll attributes
        ['STR', 'DEX', 'WITS', 'CHA'].forEach(attr => {
            let roll = (Math.floor(Math.random() * 20) + 1) * 5; // Simplified 5d20 -> 5*1d20
            if (attr === bonusAttr) roll += 25;
            newGameState.characterSheet.attributes[attr] = Math.min(100, roll);
        });

        // Set skills
        scenarioData.available_skills.forEach(skill => {
            let isCore = selectedSkills.includes(skill);
            let roll = isCore ? (Math.floor(Math.random() * 60) + 1) + 25 : (Math.floor(Math.random() * 60) + 1); // 3d20 -> 1d60 approx
            newGameState.characterSheet.skills[skill] = { value: Math.min(100, roll), type: isCore ? 'core' : 'other' };
        });

        gameState = newGameState;

        let startingMessage = scenarioData.starting_situations[startLocation] || scenarioData.starting_situations.wilderness;
        
        // Customize starting message based on location
        if(startLocation === 'roman_city') {
            const cities = ["Camulodunum", "Londinium", "Verulamium"];
            const city = cities[Math.floor(Math.random() * cities.length)];
            startingMessage = startingMessage.replace('[CITY]', city);
            gameState.characterSheet.location = city;
        } else if (startLocation === 'tribal_holding') {
            const holdings = ["the Iceni capital", "the Parisi capital", "Stanwick, the Brigante capital"];
            const holding = holdings[Math.floor(Math.random() * holdings.length)];
            startingMessage = startingMessage.replace('[HOLDING]', holding);
            gameState.characterSheet.location = holding;
        }

        startGame(startingMessage);
    }

    /**
     * Hides creation modals, shows the main app, and sets the initial state.
     * @param {string} startingMessage - The initial narrative text from the GM.
     */
    function startGame(startingMessage) {
        document.getElementById('start-modal').classList.add('hidden');
        document.getElementById('setup-modal').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');

        turnCounter = gameState.turnCounter || 1;
        updateAllUI();
        addStoryMessage(startingMessage, "GM");
        saveGameToLocalStorage(); // Autosave on game start
    }

    // --- UI & RENDER FUNCTIONS ---
    
    /**
     * A master function to update all UI components at once.
     */
    function updateAllUI() {
        renderCharacterPanel();
        renderKnownCharacters();
        renderFactions();
    }

    /**
     * Renders the main character info in the right-hand panel.
     */
    function renderCharacterPanel() {
        const display = document.getElementById('character-panel');
        const pc = gameState.characterSheet;
        if (!pc) return;

        let inventoryHTML = pc.inventory.items.map(item => `<li>- ${item}</li>`).join('');
        
        let skillsHTML = Object.entries(pc.skills)
            .sort((a, b) => b[1].value - a[1].value) // Sort skills by value
            .map(([name, data]) => 
            `<li class="flex justify-between ${data.type === 'core' ? 'text-yellow-400' : ''}"><span>${name}</span> <span>${data.value}</span></li>`
        ).join('');

        let languagesHTML = Object.entries(pc.languages).map(([name, fluency]) =>
            `<li class="flex justify-between"><span>${name}</span> <span>${fluency}%</span></li>`
        ).join('');

        let attributesHTML = Object.entries(pc.attributes).map(([name, value]) =>
            `<li class="flex justify-between"><span>${name}</span> <span>${value}</span></li>`
        ).join('');

        display.innerHTML = `
            <div class="space-y-4 text-sm">
                <div><h3 class="font-title text-xl text-yellow-400">${pc.name}</h3><p class="text-xs italic text-gray-400">${pc.physicalDescription}</p></div>
                <div><p><strong>Health:</strong> <span class="text-green-400">${pc.health}</span></p><p><strong>Status:</strong> ${pc.survivalStatus}</p></div>
                
                <details open><summary class="font-bold cursor-pointer">Attributes</summary><ul class="pl-4">${attributesHTML}</ul></details>
                <details open><summary class="font-bold cursor-pointer">Skills</summary><ul class="pl-4">${skillsHTML}</ul></details>
                <details open><summary class="font-bold cursor-pointer">Languages</summary><ul class="pl-4">${languagesHTML}</ul></details>
                <details open><summary class="font-bold cursor-pointer">Inventory</summary><ul class="pl-4"><li>${pc.inventory.currency} Denarii</li>${inventoryHTML}</ul></details>
            </div>
        `;
    }

    /**
     * Renders the list of known key characters.
     */
    function renderKnownCharacters() {
        const display = document.getElementById('known-characters-panel');
        const knownChars = gameState.playerKnowledge.knownCharacters || {};
        if (Object.keys(knownChars).length === 0) {
            display.innerHTML = `<p class="text-gray-500 italic">You have not met any key characters yet.</p>`;
            return;
        }
        display.innerHTML = Object.entries(knownChars).map(([name, data]) => `
            <div class="mb-4 p-3 bg-gray-900 bg-opacity-50 rounded-lg">
                <h3 class="font-title text-lg text-yellow-400">${name}</h3>
                ${data.description ? `<p class="text-sm"><strong>Known Info:</strong> ${data.description}</p>` : ''}
                ${data.status ? `<p class="text-sm"><strong>Status:</strong> ${data.status}</p>` : ''}
            </div>
        `).join('');
    }

    /**
     * Renders the player's reputation with various factions.
     */
    function renderFactions() {
        const display = document.getElementById('factions-panel');
        const factions = gameState.factions || {};
        const reputation = gameState.characterSheet.factionReputation || {};
         display.innerHTML = Object.keys(factions).map(name => `
            <div class="mb-2 text-sm p-2 bg-gray-900 bg-opacity-50 rounded flex justify-between items-center">
                <span>${name}</span>
                <span class="font-bold ${reputation[name] > 0 ? 'text-green-400' : reputation[name] < 0 ? 'text-red-400' : ''}">${reputation[name] || 0}</span>
            </div>
        `).join('');
    }

    /**
     * Adds a message to the story log.
     * @param {string} html - The HTML content of the message.
     * @param {string} sender - "Player" or "GM".
     */
    function addStoryMessage(html, sender = "GM") {
        const content = document.getElementById('story-content');
        const messageDiv = document.createElement('div');
        
        if (sender === "Player") {
            messageDiv.className = 'text-right mb-4';
            messageDiv.innerHTML = `<div class="bg-yellow-900 bg-opacity-50 inline-block p-3 rounded-lg text-left max-w-xl"><em>${html}</em></div>`;
        } else {
            const header = document.createElement('p');
            header.className = 'text-sm text-yellow-300 font-title';
            header.textContent = `[Turn ${turnCounter} | ${gameState.worldState.currentDate} | ${gameState.worldState.currentTime}]`;
            content.appendChild(header);
            
            messageDiv.className = 'mb-4';
            messageDiv.innerHTML = html; // Assuming GM provides safe HTML
        }
        
        content.appendChild(messageDiv);
        document.getElementById('story-container').scrollTop = document.getElementById('story-container').scrollHeight;
    }

    /**
     * Logs a message to the in-game console tab.
     * @param {string} message - The message to log.
     * @param {object} [data] - Optional data object to stringify and display.
     */
    function logToConsole(message, data) {
        const consolePanel = document.getElementById('console-panel');
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 bg-gray-900 bg-opacity-50 rounded';
        let content = `<strong>${message}</strong>`;
        if (data) {
            content += `<pre class="whitespace-pre-wrap text-xs mt-1">${JSON.stringify(data, null, 2)}</pre>`;
        }
        entry.innerHTML = content;
        consolePanel.appendChild(entry);
        consolePanel.scrollTop = consolePanel.scrollHeight;
    }
    
    /**
     * Switches the visible tab in the right-hand panel.
     * @param {string} tabName - The name of the tab to switch to.
     */
    function switchTab(tabName) {
        ['character', 'known-characters', 'factions', 'console'].forEach(t => {
            document.getElementById(`tab-${t}`).classList.remove('active');
            document.getElementById(`${t}-panel`).classList.add('hidden');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
        document.getElementById(`${tabName}-panel`).classList.remove('hidden');
    }

    // --- GAME LOGIC & API ---

    /**
     * Handles the player's action submission, sending it to the AI and processing the response.
     * @param {Event} event - The form submission event.
     */
    async function handlePlayerAction(event) {
        event.preventDefault();
        const input = document.getElementById('action-input');
        const actionText = input.value.trim();
        if (!actionText) return;

        addStoryMessage(actionText, "Player");
        input.value = '';
        input.disabled = true;
        document.querySelector('#action-form button').disabled = true;

        const fullPrompt = constructFullPrompt(actionText);
        logToConsole('Sending Prompt to API...', { promptLength: fullPrompt.length });
        
        try {
            const apiResponse = await callGeminiAPI(fullPrompt);
            logToConsole('Received Response from API:', apiResponse);
            processApiResponse(apiResponse);
            turnCounter++;
            gameState.turnCounter = turnCounter;
            saveGameToLocalStorage();
            updateAllUI();
        } catch (error) {
            // Error is already logged by callGeminiAPI, just re-enable input
            addStoryMessage(`<p class="text-red-400">A critical error occurred. Check the console for details.</p>`, "GM");
        } finally {
            input.disabled = false;
            document.querySelector('#action-form button').disabled = false;
            input.focus();
        }
    }
    
    /**
     * Merges the state changes from the API response into the current gameState.
     * This uses a deep merge to handle nested objects correctly.
     * @param {object} target - The current gameState.
     * @param {object} source - The stateChanges object from the API.
     * @returns {object} The new, merged gameState.
     */
    function mergeDeep(target, source) {
        const output = { ...target };
        if (isObject(target) && isObject(source)) {
            Object.keys(source).forEach(key => {
                if (isObject(source[key])) {
                    if (!(key in target))
                        Object.assign(output, { [key]: source[key] });
                    else
                        output[key] = mergeDeep(target[key], source[key]);
                } else {
                    Object.assign(output, { [key]: source[key] });
                }
            });
        }
        return output;
    }

    function isObject(item) {
        return (item && typeof item === 'object' && !Array.isArray(item));
    }

    /**
     * Processes the API response, updating the game state and narrative.
     * @param {object} response - The parsed JSON response from the API.
     */
    function processApiResponse(response) {
        if (!response || !response.narrative) {
            addStoryMessage(`<p class="text-red-400">Error: Received an invalid or empty response from the AI.</p>`, "GM");
            return;
        }
        if (response.stateChanges) {
            gameState = mergeDeep(gameState, response.stateChanges);
        }
        addStoryMessage(response.narrative, "GM");
    }

    /**
     * Constructs the full prompt to be sent to the Gemini API.
     * @param {string} playerAction - The text of the player's action.
     * @returns {string} The complete prompt.
     */
    function constructFullPrompt(playerAction) {
        // Create a leaner version of the gameState to send, excluding redundant data
        const stateForPrompt = {
            turnCounter: turnCounter,
            characterSheet: gameState.characterSheet,
            playerKnowledge: gameState.playerKnowledge,
            worldState: gameState.worldState
        };
        const gameStateString = JSON.stringify(stateForPrompt, null, 2);
        
        return `
--- CORE RULES ---
${coreRulesText}

--- SCENARIO CONTEXT ---
${JSON.stringify({ title: scenarioData.title, historical_context: scenarioData.historical_context, scenario_rules: scenarioData.scenario_rules }, null, 2)}

--- CURRENT GAME STATE (JSON) ---
${gameStateString}

--- PLAYER ACTION ---
${playerAction}
        `;
    }

    /**
     * Calls the Gemini API with the constructed prompt.
     * @param {string} prompt - The prompt to send.
     * @returns {Promise<object>} A promise that resolves to the parsed JSON response.
     */
    async function callGeminiAPI(prompt) {
        if (!apiKey) {
            showUIMessage("API Key is not set. Please go to Settings and enter your key.");
            throw new Error("API Key is missing.");
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                const errorMsg = data?.error?.message || `API call failed with status: ${response.status}`;
                throw new Error(errorMsg);
            }

            const responseText = data.candidates[0].content.parts[0].text;
            return JSON.parse(responseText);

        } catch (error) {
            console.error("Error calling Gemini API:", error);
            logToConsole("API Error:", { message: error.message });
            throw error;
        }
    }

    // --- SAVE / LOAD & SETTINGS LOGIC ---

    function saveGameToLocalStorage() {
        if (gameState && gameState.turnCounter > 0) {
            localStorage.setItem('rpgGameState', JSON.stringify(gameState));
            document.getElementById('continue-game-btn').disabled = false;
        }
    }

    function loadGameFromLocalStorage() {
        const savedGame = localStorage.getItem('rpgGameState');
        if (savedGame) {
            const loadedData = JSON.parse(savedGame);
            loadGameFromStateObject(loadedData);
        }
    }

    /**
     * Triggers a file download containing the current game state.
     */
    function saveGameToFile() {
        if (!gameState || !gameState.characterSheet) {
            showUIMessage("No active game to save.");
            return;
        }
        const jsonString = JSON.stringify(gameState, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Britannia_Save_T${turnCounter}_${gameState.characterSheet.name.replace(/\s/g, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showUIMessage('Save file generated!', 'success');
    }

    /**
     * Handles the logic for loading a game from a file.
     */
    function loadGameFromFile() {
        if (!fileToLoad) {
            showUIMessage("No file selected to load.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const jsonString = event.target.result;
                const loadedData = JSON.parse(jsonString);
                loadGameFromStateObject(loadedData);
            } catch (error) {
                console.error("Failed to load game from file:", error);
                showUIMessage('Failed to load game. The save file appears to be invalid or corrupted.');
            }
        };
        reader.onerror = function() {
            showUIMessage('Error reading the selected file.');
        };
        reader.readAsText(fileToLoad);
    }
    
    /**
     * Loads the game from a validated gameState object.
     * @param {object} loadedData - The parsed gameState object from a save file.
     */
    function loadGameFromStateObject(loadedData) {
        if (loadedData && loadedData.characterSheet && loadedData.turnCounter) {
            gameState = loadedData;
            document.getElementById('story-content').innerHTML = '';
            const lastEvent = gameState.worldState.majorEvents?.[gameState.worldState.majorEvents.length - 1] || "your journey";
            startGame(`Game loaded. You continue ${lastEvent}.`);
            // Close the settings modal after a successful load
            document.getElementById('settings-modal').classList.add('hidden');
        } else {
            throw new Error('Invalid save file structure.');
        }
    }
    
    function clearLocalStorage() {
        // Bypassing confirm for a smoother experience in this environment
        localStorage.removeItem('rpgGameState');
        localStorage.removeItem('rpgApiKey');
        document.getElementById('api-key-input').value = '';
        document.getElementById('continue-game-btn').disabled = true;
        showUIMessage('All local data has been cleared.', 'success');
    }

    function openSettingsModal() {
        const modal = document.getElementById('settings-modal');
        document.getElementById('settings-api-key').value = apiKey;
        if (gameState && gameState.characterSheet) {
            document.getElementById('settings-char-desc').value = gameState.characterSheet.physicalDescription;
        }
        modal.classList.remove('hidden');
    }

    function applySettings() {
        const newApiKey = document.getElementById('settings-api-key').value.trim();
        const newDesc = document.getElementById('settings-char-desc').value.trim();

        if (newApiKey) {
            apiKey = newApiKey;
            localStorage.setItem('rpgApiKey', apiKey);
        }
        if (newDesc && gameState && gameState.characterSheet) {
            gameState.characterSheet.physicalDescription = newDesc;
        }
        
        saveGameToLocalStorage();
        updateAllUI();
        document.getElementById('settings-modal').classList.add('hidden');
    }

    /**
     * Handles file selection and updates the UI.
     * @param {File} file - The file selected by the user.
     */
    function handleFileSelect(file) {
        if (file && file.type === "application/json") {
            fileToLoad = file;
            document.getElementById('drop-zone-text').textContent = `File selected: ${file.name}`;
            document.getElementById('load-file-btn').disabled = false;
        } else {
            showUIMessage("Invalid file type. Please select a .json save file.");
            fileToLoad = null;
            document.getElementById('drop-zone-text').textContent = 'Drag & Drop Save File Here or Click to Browse';
            document.getElementById('load-file-btn').disabled = true;
        }
    }

    // --- III. SCRIPT EXECUTION START ---
    // This is the entry point of the script. It waits for the HTML document to be fully
    // loaded and parsed before running any code that interacts with the DOM.
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // First, load all necessary game data.
            await loadGameData();
            
            // Now that data is loaded, set up all the event listeners.
            
            // Start Screen Buttons
            document.getElementById('continue-game-btn').addEventListener('click', () => {
                if (setApiKey()) loadGameFromLocalStorage();
            });
            document.getElementById('new-game-btn').addEventListener('click', () => {
                // REMOVED window.confirm to prevent silent failures.
                if (setApiKey()) {
                    showUIMessage('Starting a new game will clear any autosaved progress.', 'success');
                    showSetupModal();
                }
            });
            document.getElementById('clear-data-btn').addEventListener('click', clearLocalStorage);

            // Creation Modal Navigation
            document.getElementById('next-btn').addEventListener('click', () => navigateCreation(1));
            document.getElementById('prev-btn').addEventListener('click', () => navigateCreation(-1));
            document.getElementById('create-char-btn').addEventListener('click', createCharacter);

            // Main Game Actions
            document.getElementById('action-form').addEventListener('submit', handlePlayerAction);
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);

            // Main Game Tabs
            document.getElementById('tab-character').addEventListener('click', () => switchTab('character'));
            document.getElementById('tab-known-characters').addEventListener('click', () => switchTab('known-characters'));
            document.getElementById('tab-factions').addEventListener('click', () => switchTab('factions'));
            document.getElementById('tab-console').addEventListener('click', () => switchTab('console'));

            // Settings Modal Buttons
            document.getElementById('settings-apply-btn').addEventListener('click', applySettings);
            document.getElementById('settings-cancel-btn').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('return-to-start-btn').addEventListener('click', () => window.location.reload());
            
            // New Save/Load Button Listeners
            document.getElementById('save-file-btn').addEventListener('click', saveGameToFile);
            document.getElementById('load-file-btn').addEventListener('click', loadGameFromFile);

            // Drag and Drop Listeners
            const dropZone = document.getElementById('drop-zone-label');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            document.getElementById('load-file-input').addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // Finally, initialize the start screen, which shows the first modal.
            initializeStartScreen();

        } catch (error) {
            // If loadGameData fails, it will have already displayed an error message.
            console.error("Application failed to initialize.", error);
        }
    });

    </script>
</body>
</html>
